<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epubly - Prémium EPUB Olvasó</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --brand: #D4AF37;
            --brand-soft: #3A2F14;
            --bg: #000000;
            --bg-elevated: #0D0D0D;
            --surface: #111111;
            --surface-alt: #1A1A1A;
            --text: #EDEDED;
            --text-muted: #A0A0A0;
            --border: #222222;
            --danger: #e53e3e;
            --radius-s: 8px;
            --radius-m: 14px;
            --radius-l: 22px;
            --shadow-xs: 0 1px 2px rgba(0,0,0,0.4);
            --shadow-s: 0 2px 6px rgba(0,0,0,0.5);
            --shadow-m: 0 6px 18px rgba(0,0,0,0.55);
            --shadow-l: 0 12px 32px rgba(0,0,0,0.6);
            --space-1: 4px; --space-2: 8px; --space-3: 12px; --space-4: 16px; --space-5: 24px; --space-6: 32px; --space-7: 48px;
            --transition: 0.25s cubic-bezier(0.4, 0.0, 0.2, 1);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { color-scheme: dark; }
        body {
            background-color: var(--bg); color: var(--text); font-size: 16px; line-height: 1.6;
            overflow: hidden; height: 100vh; display: flex; flex-direction: column;
        }

        /* --- HEADER --- */
        #topbar {
            height: 60px; display: flex; justify-content: space-between; align-items: center;
            padding: 0 var(--space-5); background: var(--bg-elevated); border-bottom: 1px solid var(--border);
            z-index: 100;
        }
        .logo { font-weight: 700; font-size: 1.2rem; color: var(--brand); letter-spacing: -0.5px; }
        .top-actions { display: flex; gap: var(--space-3); align-items: center; }

        /* --- VIEWS --- */
        .view-section { display: none; width: 100%; height: calc(100vh - 60px - 30px); overflow: hidden; }
        .view-section.active { display: block; }
        
        /* Library View */
        #library-view { overflow-y: auto; padding: var(--space-6); }
        .library-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-5); max-width: 1200px; margin-left: auto; margin-right: auto; }
        #library-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: var(--space-6); 
            max-width: 1200px; margin: 0 auto;
        }
        
        /* Reader View Layout */
        #reader-view.active { display: grid; grid-template-columns: auto 1fr auto; grid-template-rows: 1fr; }
        #reader-sidebar-left { width: 300px; background: var(--bg-elevated); border-right: 1px solid var(--border); display: none; flex-direction: column; }
        #reader-sidebar-left.visible { display: flex; }
        #reader-main { position: relative; overflow: hidden; }
        #viewer { width: 100%; height: 100%; }

        /* --- COMPONENTS --- */
        .btn { padding: var(--space-2) var(--space-4); border-radius: var(--radius-s); border: none; cursor: pointer; font-weight: 500; transition: var(--transition); display: inline-flex; align-items: center; gap: 6px; }
        .btn-primary { background-color: var(--brand); color: var(--bg); }
        .btn-primary:hover { filter: brightness(1.1); }
        .btn-secondary { background-color: var(--surface-alt); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { background-color: var(--border); }
        .btn-danger { background-color: rgba(229, 62, 62, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        .btn-danger:hover { background-color: var(--danger); color: white; }
        .icon-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: var(--transition); }
        .icon-btn:hover { color: var(--text); background: var(--surface-alt); }
        .icon-btn.active { color: var(--brand); background: var(--brand-soft); }

        /* Book Card */
        .book-card { background: var(--surface); border-radius: var(--radius-m); padding: var(--space-3); transition: transform var(--transition), box-shadow var(--transition); cursor: pointer; border: 1px solid transparent; }
        .book-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-m); border-color: var(--border); }
        .book-cover { width: 100%; aspect-ratio: 2/3; background: var(--surface-alt); border-radius: var(--radius-s); overflow: hidden; margin-bottom: var(--space-3); position: relative; }
        .book-cover img { width: 100%; height: 100%; object-fit: cover; }
        .book-title { font-weight: 600; font-size: 1rem; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .book-author { font-size: 0.85rem; color: var(--text-muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Modals */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity var(--transition); }
        .modal.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background: var(--surface); width: 90%; max-width: 600px; border-radius: var(--radius-l); padding: var(--space-6); border: 1px solid var(--border); max-height: 90vh; overflow-y: auto; }
        
        /* Book Details Modal Specifics */
        .book-detail-layout { display: grid; grid-template-columns: 180px 1fr; gap: var(--space-5); }
        .book-detail-cover { width: 100%; aspect-ratio: 2/3; background: var(--surface-alt); border-radius: var(--radius-m); overflow: hidden; }
        .book-detail-cover img { width: 100%; height: 100%; object-fit: cover; }
        .book-desc { color: var(--text-muted); font-size: 0.95rem; line-height: 1.6; max-height: 200px; overflow-y: auto; margin: var(--space-4) 0; padding-right: var(--space-2); }
        
        /* TOC List */
        #toc-list { list-style: none; padding: var(--space-4); }
        #toc-list li a { display: block; padding: 8px; color: var(--text-muted); text-decoration: none; border-radius: var(--radius-s); transition: var(--transition); }
        #toc-list li a:hover { background: var(--surface-alt); color: var(--text); }
        #toc-list li a.active { color: var(--brand); font-weight: 500; }

        /* Loader */
        #loader { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s; }
        #loader.hidden { opacity: 0; pointer-events: none; }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--surface-alt); border-top-color: var(--brand); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: var(--space-3); }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Footer */
        #app-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--bg-elevated); padding: 4px; text-align: center; font-size: 0.75rem; color: var(--text-muted); border-top: 1px solid var(--border); z-index: 1500; }

        /* Mobile Adjustments */
        @media (max-width: 600px) {
            .book-detail-layout { grid-template-columns: 1fr; }
            .book-detail-cover { width: 140px; margin: 0 auto; }
            #reader-sidebar-left { position: absolute; inset: 0; width: 100%; z-index: 50; }
        }
    </style>
</head>
<body>

    <!-- GLOBAL LOADER -->
    <div id="loader">
        <div class="spinner"></div>
        <p id="loader-msg">Rendszer indítása...</p>
    </div>

    <!-- HEADER -->
    <header id="topbar">
        <div style="display: flex; align-items: center; gap: 12px;">
            <span class="logo">Epubly</span>
            <span class="view-title" style="color: var(--text-muted); font-size: 0.9rem; border-left: 1px solid var(--border); padding-left: 12px;" id="header-title">Könyvtár</span>
        </div>
        <div class="top-actions" id="top-actions-container">
            <!-- Injected by JS based on view -->
        </div>
    </header>

    <!-- LIBRARY VIEW -->
    <section id="library-view" class="view-section active">
        <div class="library-header">
            <h2>Könyvespolc</h2>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="Epubly.ui.showModal('import-modal')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Importálás
                </button>
                <button class="icon-btn" onclick="Epubly.ui.showModal('settings-modal')" title="Beállítások">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                </button>
            </div>
        </div>
        <div id="library-grid">
            <!-- Books injected here -->
        </div>
    </section>

    <!-- READER VIEW -->
    <section id="reader-view" class="view-section">
        <aside id="reader-sidebar-left">
            <div style="padding: 16px; border-bottom: 1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                <h3>Tartalom</h3>
                <button class="icon-btn" onclick="document.getElementById('reader-sidebar-left').classList.remove('visible')">&times;</button>
            </div>
            <div style="flex:1; overflow-y:auto;">
                <ul id="toc-list"></ul>
            </div>
            <div style="padding:16px; border-top:1px solid var(--border);">
                 <input type="text" id="in-book-search" placeholder="Keresés..." style="width:100%; padding:8px; background:var(--bg); border:1px solid var(--border); color:white; border-radius:4px;">
            </div>
        </aside>
        <div id="reader-main">
            <div id="viewer"></div>
            <!-- Invisible click areas for navigation -->
            <div style="position:absolute; top:0; left:0; width:15%; height:100%; z-index:10; cursor:pointer;" onclick="Epubly.reader.prevPage()"></div>
            <div style="position:absolute; top:0; right:0; width:15%; height:100%; z-index:10; cursor:pointer;" onclick="Epubly.reader.nextPage()"></div>
        </div>
    </section>

    <!-- BOOK DETAILS MODAL -->
    <div id="book-details-modal" class="modal">
        <div class="modal-content">
            <div class="book-detail-layout">
                <div class="book-detail-cover">
                    <img id="detail-cover-img" src="" alt="Book Cover">
                </div>
                <div style="display:flex; flex-direction:column;">
                    <button class="icon-btn" style="align-self: flex-end; margin-top:-10px; margin-right:-10px;" onclick="Epubly.ui.hideModal('book-details-modal')">&times;</button>
                    <h2 id="detail-title" style="margin-bottom:4px; line-height:1.2;">Cím</h2>
                    <p id="detail-author" style="color:var(--brand); margin-bottom:12px;">Szerző</p>
                    <div id="detail-desc" class="book-desc">
                        <!-- Description injected here -->
                    </div>
                    <div style="margin-top:auto; display:flex; gap:12px; padding-top:16px;">
                        <button id="btn-read-book" class="btn btn-primary" style="flex:1; justify-content:center;">Olvasás</button>
                        <button id="btn-delete-book" class="btn btn-danger">Törlés</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- IMPORT MODAL -->
    <div id="import-modal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:16px;">
                <h2>Könyv importálása</h2>
                <button class="icon-btn" onclick="Epubly.ui.hideModal('import-modal')">&times;</button>
            </div>
            <div style="padding: 24px; border: 2px dashed var(--border); border-radius: var(--radius-m); text-align:center;">
                <input type="file" id="epub-file" accept=".epub" style="display:none" onchange="Epubly.storage.handleFileUpload(this.files[0])">
                <button class="btn btn-secondary" onclick="document.getElementById('epub-file').click()">Fájl kiválasztása (.epub)</button>
                <p style="margin-top:12px; color:var(--text-muted); font-size:0.9rem;">A könyvek a böngésződben tárolódnak.</p>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:16px;">
                <h2>Beállítások</h2>
                <button class="icon-btn" onclick="Epubly.ui.hideModal('settings-modal')">&times;</button>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; color:var(--text-muted); margin-bottom:8px;">Téma</label>
                <div style="display:flex; gap:8px;">
                    <button class="btn btn-secondary" style="flex:1;" onclick="Epubly.settings.applyTheme('oled')">OLED</button>
                    <button class="btn btn-secondary" style="flex:1;" onclick="Epubly.settings.applyTheme('sepia')">Szépia</button>
                    <button class="btn btn-secondary" style="flex:1;" onclick="Epubly.settings.applyTheme('light')">Világos</button>
                </div>
            </div>

            <div style="margin-bottom:20px;">
                <label style="display:block; color:var(--text-muted); margin-bottom:8px;">Betűméret</label>
                <input type="range" id="font-size-range" min="80" max="200" step="10" style="width:100%" oninput="Epubly.settings.update('fontSize', this.value)">
            </div>

            <div style="margin-top:30px; border-top:1px solid var(--border); padding-top:20px;">
                <button class="btn btn-danger" style="width:100%; justify-content:center;" onclick="Epubly.storage.clearCache()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                    Gyorsítótár és könyvek törlése
                </button>
            </div>
        </div>
    </div>

    <footer id="app-footer">
        Epubly v<span id="version-display"></span> &copy; <span id="year-display"></span>
    </footer>

    <!-- DEPENDENCIES -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/epub.js/0.3.93/epub.min.js"></script>

    <!-- APP LOGIC -->
    <script>
        const APP_VERSION = '1.0.0';

        const Epubly = {
            state: {
                view: 'library', // 'library' or 'reader'
                book: null,
                rendition: null,
                currentBookId: null,
            },

            init() {
                // UI Init
                document.getElementById('version-display').textContent = APP_VERSION;
                document.getElementById('year-display').textContent = new Date().getFullYear();
                
                // DB Init
                this.storage.db.init().then(() => {
                    this.library.render();
                    this.settings.load();
                    this.ui.hideLoader();
                }).catch(err => {
                    alert('Hiba az adatbázis inicializálása közben: ' + err);
                    this.ui.hideLoader();
                });
            },

            ui: {
                showLoader(msg) { 
                    const l = document.getElementById('loader'); 
                    l.classList.remove('hidden'); 
                    if(msg) document.getElementById('loader-msg').textContent = msg; 
                },
                hideLoader() { document.getElementById('loader').classList.add('hidden'); },
                
                switchView(viewName) {
                    Epubly.state.view = viewName;
                    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                    
                    const headerTitle = document.getElementById('header-title');
                    const actions = document.getElementById('top-actions-container');

                    if (viewName === 'library') {
                        document.getElementById('library-view').classList.add('active');
                        headerTitle.textContent = 'Könyvtár';
                        actions.innerHTML = ''; // Actions handled in library sub-header
                        Epubly.library.render(); // Refresh grid
                    } else if (viewName === 'reader') {
                        document.getElementById('reader-view').classList.add('active');
                        // headerTitle is set by book title usually
                        actions.innerHTML = `
                            <button class="btn btn-secondary" onclick="Epubly.reader.close()">Vissza a polchoz</button>
                            <button class="icon-btn" onclick="document.getElementById('reader-sidebar-left').classList.toggle('visible')">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
                            </button>
                            <button class="icon-btn" onclick="Epubly.ui.showModal('settings-modal')">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                            </button>
                        `;
                    }
                },

                showModal(id) { document.getElementById(id).classList.add('visible'); },
                hideModal(id) { document.getElementById(id).classList.remove('visible'); },

                showBookDetails(book) {
                    document.getElementById('detail-cover-img').src = book.metadata.coverUrl || '';
                    document.getElementById('detail-title').textContent = book.metadata.title;
                    document.getElementById('detail-author').textContent = book.metadata.creator;
                    document.getElementById('detail-desc').innerHTML = book.metadata.description || 'Nincs elérhető leírás.';
                    
                    document.getElementById('btn-read-book').onclick = () => {
                        this.hideModal('book-details-modal');
                        Epubly.reader.open(book);
                    };
                    document.getElementById('btn-delete-book').onclick = () => {
                         if(confirm('Biztosan törlöd ezt a könyvet?')) {
                             Epubly.storage.db.deleteBook(book.id).then(() => {
                                 this.hideModal('book-details-modal');
                                 Epubly.library.render();
                             });
                         }
                    };

                    this.showModal('book-details-modal');
                }
            },

            library: {
                async render() {
                    const grid = document.getElementById('library-grid');
                    grid.innerHTML = '<p style="color:var(--text-muted);">Betöltés...</p>';
                    const books = await Epubly.storage.db.getAllBooks();
                    grid.innerHTML = '';

                    if (books.length === 0) {
                        grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--text-muted); border:1px dashed var(--border); border-radius:12px;">
                            <p>A könyvtárad üres.</p>
                            <p>Tölts fel egy könyvet az "Importálás" gombbal.</p>
                        </div>`;
                        return;
                    }

                    books.forEach(book => {
                        const div = document.createElement('div');
                        div.className = 'book-card';
                        div.innerHTML = `
                            <div class="book-cover">
                                <img src="${book.metadata.coverUrl || ''}" onerror="this.style.display='none'">
                            </div>
                            <div class="book-title">${book.metadata.title}</div>
                            <div class="book-author">${book.metadata.creator}</div>
                        `;
                        div.onclick = () => Epubly.ui.showBookDetails(book);
                        grid.appendChild(div);
                    });
                }
            },

            reader: {
                async open(book) {
                    Epubly.ui.showLoader('Könyv megnyitása...');
                    try {
                        Epubly.ui.switchView('reader');
                        document.getElementById('header-title').textContent = book.metadata.title;

                        if (Epubly.state.book) { Epubly.state.book.destroy(); }

                        const settings = Epubly.settings.get();
                        Epubly.state.book = new window.ePub(book.data);
                        Epubly.state.rendition = Epubly.state.book.renderTo("viewer", {
                            width: "100%", height: "100%",
                            flow: "paginated",
                            spread: "auto"
                        });

                        const savedLoc = localStorage.getItem('epubly-loc-' + book.id);
                        await Epubly.state.rendition.display(savedLoc || undefined);

                        Epubly.state.currentBookId = book.id;
                        Epubly.state.book.ready.then(() => {
                            // Generate TOC
                            const tocList = document.getElementById('toc-list');
                            tocList.innerHTML = '';
                            Epubly.state.book.navigation.toc.forEach(chapter => {
                                const li = document.createElement('li');
                                const a = document.createElement('a');
                                a.textContent = chapter.label.trim();
                                a.href = "#";
                                a.onclick = (e) => {
                                    e.preventDefault();
                                    Epubly.state.rendition.display(chapter.href);
                                    document.getElementById('reader-sidebar-left').classList.remove('visible');
                                };
                                li.appendChild(a);
                                tocList.appendChild(li);
                            });
                            this.applySettings();
                        });

                        Epubly.state.rendition.on("relocated", location => {
                            localStorage.setItem('epubly-loc-' + book.id, location.start.cfi);
                        });

                    } catch(e) {
                        console.error(e);
                        alert("Hiba a könyv megnyitásakor.");
                        Epubly.ui.switchView('library');
                    } finally {
                        Epubly.ui.hideLoader();
                    }
                },
                close() {
                    Epubly.ui.switchView('library');
                    if (Epubly.state.book) {
                        Epubly.state.book.destroy();
                        Epubly.state.book = null;
                    }
                },
                nextPage() { Epubly.state.rendition?.next(); },
                prevPage() { Epubly.state.rendition?.prev(); },
                applySettings() {
                    if (!Epubly.state.rendition) return;
                    const s = Epubly.settings.get();
                    const themes = Epubly.state.rendition.themes;
                    themes.fontSize(s.fontSize + '%');
                    
                    const colors = {
                        oled: { text: '#EDEDED', bg: '#000000' },
                        sepia: { text: '#5b4636', bg: '#fbf0d9' },
                        light: { text: '#111111', bg: '#ffffff' }
                    };
                    const c = colors[s.theme] || colors.oled;
                    themes.register("custom", { "body": { "color": c.text, "background-color": c.bg } });
                    themes.select("custom");
                }
            },

            storage: {
                db: {
                    _db: null,
                    async init() {
                        return new Promise((resolve, reject) => {
                            const req = indexedDB.open('EpublyV1', 1);
                            req.onerror = e => reject(e);
                            req.onsuccess = e => { this._db = e.target.result; resolve(this._db); };
                            req.onupgradeneeded = e => {
                                if (!e.target.result.objectStoreNames.contains('books')) {
                                    e.target.result.createObjectStore('books', { keyPath: 'id' });
                                }
                            };
                        });
                    },
                    async saveBook(book) {
                        const tx = this._db.transaction(['books'], 'readwrite');
                        return new Promise((res, rej) => {
                            const req = tx.objectStore('books').put(book);
                            req.onsuccess = () => res();
                            req.onerror = () => rej();
                        });
                    },
                    async getAllBooks() {
                        const tx = this._db.transaction(['books'], 'readonly');
                        return new Promise(res => {
                            tx.objectStore('books').getAll().onsuccess = e => res(e.target.result);
                        });
                    },
                    async deleteBook(id) {
                        const tx = this._db.transaction(['books'], 'readwrite');
                        return new Promise(res => {
                            tx.objectStore('books').delete(id).onsuccess = () => res();
                        });
                    }
                },
                async handleFileUpload(file) {
                    if(!file) return;
                    Epubly.ui.showLoader('Könyv feldolgozása...');
                    try {
                        const buffer = await file.arrayBuffer();
                        const book = new window.ePub(buffer);
                        const meta = await book.loaded.metadata;
                        const coverUrl = await book.coverUrl();
                        
                        // Extract cover image as Blob URL
                        let finalCover = null;
                        if(coverUrl) {
                            const r = await fetch(coverUrl);
                            const b = await r.blob();
                            finalCover = URL.createObjectURL(b);
                        }

                        const record = {
                            id: Date.now().toString(),
                            data: buffer,
                            metadata: {
                                title: meta.title || file.name,
                                creator: meta.creator || 'Ismeretlen',
                                description: meta.description || '',
                                coverUrl: finalCover
                            }
                        };
                        
                        await this.db.saveBook(record);
                        Epubly.ui.hideModal('import-modal');
                        Epubly.library.render();
                    } catch(e) {
                        alert('Hiba az importálás során: ' + e);
                    } finally {
                        Epubly.ui.hideLoader();
                    }
                },
                clearCache() {
                    if(confirm('Ez töröl minden könyvet és beállítást. Folytatod?')) {
                        indexedDB.deleteDatabase('EpublyV1');
                        localStorage.clear();
                        location.reload();
                    }
                }
            },

            settings: {
                get() {
                    return JSON.parse(localStorage.getItem('epubly-settings')) || { theme: 'oled', fontSize: 100 };
                },
                update(key, val) {
                    const s = this.get();
                    s[key] = val;
                    localStorage.setItem('epubly-settings', JSON.stringify(s));
                    Epubly.reader.applySettings();
                },
                applyTheme(t) {
                    this.update('theme', t);
                },
                load() {
                    const s = this.get();
                    document.getElementById('font-size-range').value = s.fontSize;
                }
            }
        };

        // Boot
        window.addEventListener('load', () => setTimeout(Epubly.init.bind(Epubly), 100));
    </script>
</body>
</html>
